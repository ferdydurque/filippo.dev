/**
 *
 * Version: 0.2.8
 * Author:  Gianluca Guarini
 * Contact: gianluca.guarini@gmail.com
 * Website: http://www.gianlucaguarini.com/
 * Twitter: @gianlucaguarini
 *
 * Copyright (c) 2013 Gianluca Guarini
 */!function(e){e.fn.extend({BlackAndWhite:function(t){"use strict";var n=this,r={hoverEffect:!0,webworkerPath:!1,responsive:!0,invertHoverEffect:!1,speed:500,onImageReady:null,intensity:1};t=e.extend(r,t);var i=t.hoverEffect,s=t.webworkerPath,o=t.invertHoverEffect,u=t.responsive,f="number"==typeof t.intensity&&t.intensity<1&&t.intensity>0?t.intensity:1,l=e.isPlainObject(t.speed)?t.speed.fadeIn:t.speed,c=e.isPlainObject(t.speed)?t.speed.fadeOut:t.speed,h=document.all&&!window.opera&&window.XMLHttpRequest?!0:!1,p=" -webkit- -moz- -o- -ms- ".split(" "),d={},v=function(e){if(d[e]||""===d[e])return d[e]+e;var t=document.createElement("div"),n=["","Moz","Webkit","O","ms","Khtml"];for(var r in n)if("undefined"!=typeof t.style[n[r]+e])return d[e]=n[r],n[r]+e;return e.toLowerCase()},m=function(){var e=document.createElement("div");return e.style.cssText=p.join("filter:blur(2px); "),!!e.style.length&&(void 0===document.documentMode||document.documentMode>9)}(),g=!!document.createElement("canvas").getContext,y=e(window),b=function(){return"undefined"!=typeof Worker?!0:!1}(),w=(v("Filter"),[]),E=b&&s?new Worker(s+"BnWWorker.js"):!1,S=function(t){e(t.currentTarget).find(".BWfade").stop(!0,!0)[o?"fadeOut":"fadeIn"](c)},x=function(t){e(t.currentTarget).find(".BWfade").stop(!0,!0)[o?"fadeIn":"fadeOut"](l)},T=function(e){"function"==typeof t.onImageReady&&t.onImageReady(e)},N=function(){return w.length?(E.postMessage({imgData:w[0].imageData,intensity:f}),E.onmessage=function(e){w[0].ctx.putImageData(e.data,0,0),T(w[0].img),w.splice(0,1),N()},void 0):(E.terminate&&E.terminate(),E.close&&E.close(),void 0)},C=function(e,t,n,r){var i=t.getContext("2d"),s=0;i.drawImage(e,0,0,n,r);var o=i.getImageData(0,0,n,r),u=o.data,a=u.length;if(E)w.push({imageData:o,ctx:i,img:e});else{for(;a>s;s+=4){var l=.3*u[s]+.59*u[s+1]+.11*u[s+2];u[s]=~~(l*f+u[s]*(1-f)),u[s+1]=~~(l*f+u[s+1]*(1-f)),u[s+2]=~~(l*f+u[s+2]*(1-f))}i.putImageData(o,0,0),T(e)}},k=function(t,n){var r=t[0],i=r.src,s=t.width(),u=t.height(),l=t.position(),c={position:"absolute",top:l.top,left:l.left,display:o?"none":"block"};if(g&&!m){var h=r.width,p=r.height;e('<canvas class="BWfade" width="'+h+'" height="'+p+'"></canvas>').prependTo(n);var d=n.find("canvas");d.css(c),C(r,d[0],h,p)}else c[v("Filter")]="grayscale("+100*f+"%)",e("<img src="+i+' width="'+s+'" height="'+u+'" class="BWFilter BWfade" /> ').prependTo(n),e(".BWFilter").css(e.extend(c,{filter:"progid:DXImageTransform.Microsoft.BasicImage(grayscale=1)"})),T(r)};return this.init=function(){n.each(function(t,n){var r=e(n),i=r.find("img");i.width()?k(i,r):i.on("load",function(){k(i,r)})}),E&&N(),i&&(n.on("mouseleave",S),n.on("mouseenter",x)),u&&y.on("resize orientationchange",n.resizeImages)},this.resizeImages=function(){n.each(function(t,n){var r=e(n).find("img:not(.BWFilter)"),i=h?e(r).prop("width"):e(r).width(),s=h?e(r).prop("height"):e(r).height();e(this).find(".BWFilter, canvas").css({width:i,height:s})})},this.init(t)}})}(jQuery);